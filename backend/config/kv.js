class KVDatabase {
  constructor() {
    // å°‡åœ¨ database.js ä¸­è¨­ç½® this.kv
    this.kv = null;
  }

  // ç”¨æˆ¶ç›¸é—œæ“ä½œ
  async createUser(userData) {
    const userId = `user:${Date.now()}`;
    await this.kv.hset(userId, userData);
    await this.kv.sadd('users', userId);
    return userId;
  }

  async getUserByUsername(username) {
    const userIds = await this.kv.smembers('users');
    for (const userId of userIds) {
      const user = await this.kv.hgetall(userId);
      if (user.username === username) {
        return { id: userId, ...user };
      }
    }
    return null;
  }

  async getUserById(userId) {
    const user = await this.kv.hgetall(userId);
    return user ? { id: userId, ...user } : null;
  }

  async updateUser(userId, userData) {
    await this.kv.hset(userId, userData);
    return true;
  }

  // å½±ç‰‡ç›¸é—œæ“ä½œ
  async createVideo(videoData) {
    const videoId = `video:${Date.now()}`;
    const video = {
      ...videoData,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    await this.kv.hset(videoId, video);
    await this.kv.sadd('videos', videoId);
    
    // å¦‚æœæ˜¯ç²¾é¸å½±ç‰‡ï¼ŒåŠ å…¥ç²¾é¸åˆ—è¡¨
    if (videoData.is_featured) {
      await this.kv.sadd('featured_videos', videoId);
    }
    
    return videoId;
  }

  async getVideos(options = {}) {
    const { featured, limit, offset } = options;
    let videoIds;
    
    if (featured) {
      videoIds = await this.kv.smembers('featured_videos');
    } else {
      videoIds = await this.kv.smembers('videos');
    }
    
    // ç²å–å½±ç‰‡è©³æƒ…
    const videos = [];
    for (const videoId of videoIds) {
      const video = await this.kv.hgetall(videoId);
      if (video && Object.keys(video).length > 0) {
        videos.push({ id: videoId, ...video });
      }
    }
    
    // æŒ‰å‰µå»ºæ™‚é–“æ’åº
    videos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    // åˆ†é 
    if (limit) {
      const start = offset || 0;
      return videos.slice(start, start + limit);
    }
    
    return videos;
  }

  async getVideoById(videoId) {
    const video = await this.kv.hgetall(videoId);
    return video ? { id: videoId, ...video } : null;
  }

  async updateVideo(videoId, videoData) {
    const updatedData = {
      ...videoData,
      updated_at: new Date().toISOString()
    };
    
    // æ›´æ–°å½±ç‰‡æ•¸æ“š
    await this.kv.hset(videoId, updatedData);
    
    // æ›´æ–°ç²¾é¸ç‹€æ…‹
    if (videoData.is_featured) {
      await this.kv.sadd('featured_videos', videoId);
    } else {
      await this.kv.srem('featured_videos', videoId);
    }
    
    return true;
  }

  async deleteVideo(videoId) {
    await this.kv.del(videoId);
    await this.kv.srem('videos', videoId);
    await this.kv.srem('featured_videos', videoId);
    return true;
  }

  // é »é“è³‡è¨Šæ“ä½œ
  async getChannelInfo() {
    const channelInfo = await this.kv.hgetall('channel_info');
    return channelInfo || {};
  }

  async updateChannelInfo(channelData) {
    const updatedData = {
      ...channelData,
      updated_at: new Date().toISOString()
    };
    await this.kv.hset('channel_info', updatedData);
    return true;
  }

  // ç¶²ç«™è¨­ç½®æ“ä½œ
  async getSiteSetting(key) {
    return await this.kv.hget('site_settings', key);
  }

  async setSiteSetting(key, value) {
    await this.kv.hset('site_settings', { [key]: value });
    return true;
  }

  async getAllSiteSettings() {
    return await this.kv.hgetall('site_settings') || {};
  }

  // çµ±è¨ˆæ•¸æ“š
  async getStats() {
    const videoIds = await this.kv.smembers('videos');
    const featuredIds = await this.kv.smembers('featured_videos');
    
    let totalViews = 0;
    for (const videoId of videoIds) {
      const video = await this.kv.hgetall(videoId);
      if (video.view_count) {
        totalViews += parseInt(video.view_count) || 0;
      }
    }
    
    const channelInfo = await this.getChannelInfo();
    
    return {
      total_videos: videoIds.length,
      featured_videos: featuredIds.length,
      total_views: totalViews,
      subscriber_count: parseInt(channelInfo.subscriber_count) || 0
    };
  }

  // åˆå§‹åŒ–æ•¸æ“š
  async initializeData() {
    try {
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ¶
      const users = await this.kv.smembers('users');
      
      if (users.length === 0) {
        console.log('ğŸ“ å‰µå»ºé»˜èªç®¡ç†å“¡ç”¨æˆ¶...');
        const bcrypt = require('bcryptjs');
        const hashedPassword = await bcrypt.hash('admin', 10);
        
        await this.createUser({
          username: 'CRCRC',
          password: hashedPassword,
          role: 'admin',
          created_at: new Date().toISOString()
        });
        
        console.log('âœ… é»˜èªç®¡ç†å“¡ç”¨æˆ¶å‰µå»ºæˆåŠŸ (ç”¨æˆ¶å: CRCRC, å¯†ç¢¼: admin)');
      }

      // æª¢æŸ¥æ˜¯å¦å·²æœ‰é »é“è³‡è¨Š
      const channelInfo = await this.getChannelInfo();
      
      if (!channelInfo.channel_name) {
        console.log('ğŸ“ å‰µå»ºé»˜èªé »é“è³‡è¨Š...');
        await this.updateChannelInfo({
          channel_name: 'CRCRC',
          description: 'å‰µä½œç©ºè€³èˆ‡è’é‡äº‚é¬¥å…§å®¹çš„é »é“ï¼Œæ­¡è¿è¨‚é–±ï¼Œä¸€èµ·ç©éŸ³æ¨‚ç©éŠæˆ²ï¼',
          youtube_url: 'https://youtube.com/@officialcrcrcyt',
          discord_url: 'https://discord.gg/FyrNaF6Nbj',
          minecraft_discord_url: 'https://discord.gg/9jBCTheX3Y',
          subscriber_count: 0,
          total_views: 0,
          created_at: new Date().toISOString()
        });
        console.log('âœ… é»˜èªé »é“è³‡è¨Šå‰µå»ºæˆåŠŸ');
      }

      // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç¤ºä¾‹å½±ç‰‡
      const videos = await this.getVideos();
      
      if (videos.length === 0) {
        console.log('ğŸ“ å‰µå»ºç¤ºä¾‹å½±ç‰‡æ•¸æ“š...');
        
        // ä¸å‰µå»ºç¤ºä¾‹å½±ç‰‡ï¼Œè®“ç®¡ç†å“¡è‡ªå·±æ·»åŠ çœŸå¯¦å½±ç‰‡
        const sampleVideos = [];

        if (sampleVideos.length > 0) {
          for (const video of sampleVideos) {
            await this.createVideo(video);
          }
          console.log('âœ… ç¤ºä¾‹å½±ç‰‡æ•¸æ“šå‰µå»ºæˆåŠŸ');
        } else {
          console.log('â„¹ï¸  è·³éç¤ºä¾‹å½±ç‰‡å‰µå»ºï¼Œè«‹åœ¨ç®¡ç†å¾Œå°æ·»åŠ çœŸå¯¦å½±ç‰‡');
        }
      }

      // è¨­ç½®é»˜èªç¶²ç«™è¨­ç½®
      const siteSettings = await this.getAllSiteSettings();
      
      if (!siteSettings.site_title) {
        console.log('ğŸ“ å‰µå»ºé»˜èªç¶²ç«™è¨­ç½®...');
        await this.setSiteSetting('site_title', 'CRCRC å®˜æ–¹ç¶²ç«™');
        await this.setSiteSetting('site_description', 'å‰µä½œç©ºè€³èˆ‡è’é‡äº‚é¬¥å…§å®¹çš„é »é“ï¼Œæ­¡è¿è¨‚é–±ï¼Œä¸€èµ·ç©éŸ³æ¨‚ç©éŠæˆ²ï¼');
        await this.setSiteSetting('contact_email', 'contact@crcrc.com');
        await this.setSiteSetting('featured_video_count', '6');
        console.log('âœ… é»˜èªç¶²ç«™è¨­ç½®å‰µå»ºæˆåŠŸ');
      }

      console.log('ğŸ‰ KV æ•¸æ“šåº«åˆå§‹åŒ–å®Œæˆï¼');
      return true;
    } catch (error) {
      console.error('âŒ KV æ•¸æ“šåº«åˆå§‹åŒ–å¤±æ•—:', error);
      throw error;
    }
  }
}

module.exports = new KVDatabase();